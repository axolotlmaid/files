<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ file }} — {{ page_title }}</title>

        <meta name="title" content="{{ file }} — {{ page_title }}" />
        <meta property="og:image" content="/uploads/{{ file }}/raw" />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="250" />
        <meta property="og:image:height" content="250" />
        <meta name="theme-color" content="#ffa6c1" />

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        />

        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/default.min.css"
        />
        <link
            rel="stylesheet"
            href="//unpkg.com/@catppuccin/highlightjs@0.2.2/css/catppuccin-mocha.css"
        />

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"
            async
        ></script>

        <style>
            body {
                display: grid;
                grid-template-rows: 5rem auto;

                min-height: 100vh;
                margin: 0;
                overflow-x: hidden;

                background-color: #181825;
                color: #ffa6c1;

                font-family: "JetBrains Mono", monospace;
            }

            header {
                display: grid;
                grid-template-columns: 1fr 20rem;
                align-items: center;

                padding: 0.5rem 1rem;
                border-bottom: 2px solid #ffa6c1;

                background-color: #1e1e2e;
            }

            #left {
                display: flex;
                flex-direction: column;

                font-size: 0.875rem;
                overflow-x: auto;
            }

            #file-name {
                font-size: 2rem;
                font-weight: 900;
            }

            #file-modified {
                color: #ffa6c180;
            }

            #right {
                display: flex;
                justify-content: end;
                align-items: center;

                gap: 24px;
                height: 100%;
            }

            #file-size {
                font-weight: 600;
            }

            #seperator {
                display: block;
                background-color: #ffa6c1;
                width: 2px;
                height: 75%;
            }

            #links {
                display: flex;
                align-items: center;
                margin-right: 1rem;
            }

            #links a {
                display: flex;
                justify-content: center;
                align-items: center;

                width: 2.5rem;
                height: 2.5rem;

                font-size: 1.25rem;
                font-weight: 500;
                text-decoration: none;
                color: #ffa6c1;

                cursor: pointer;
                user-select: none;

                transition: 200ms;
                transition-property: filter transform;
            }

            #links a:active {
                transform: scale(0.8);
            }

            .tooltip {
                position: relative;
            }

            .tooltip::before {
                min-width: 4rem;

                position: absolute;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);

                margin-top: 0.5rem;
                padding: 0.25rem 0.35rem;

                border: 1px solid #ffa6c180;
                border-radius: 4px;

                background-color: #1e1e2e;
                color: #ffa6c1;

                font-size: 0.85rem;
                text-align: center;
                text-wrap: nowrap;

                content: attr(data-tooltip);

                visibility: hidden;
                opacity: 0;

                /* transition: 300ms opacity; */
            }

            .tooltip:hover:before {
                visibility: visible;
                opacity: 1;

                transition: 300ms opacity;
            }

            main {
                display: flex;
                justify-content: center;
                align-items: center;

                width: 100vw;
            }

            img,
            video {
                max-width: 100%;
            }

            pre {
                width: 100%;
                height: 100%;

                padding: 1rem;
                box-sizing: border-box;
            }

            code {
                width: 100%;
                height: 100%;

                background-color: transparent !important;
                padding: 0 !important;

                font-family: "JetBrains Mono", monospace;
            }

            canvas {
                cursor: grab;
            }

            #error {
                display: none;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 4px;

                font-size: 1.5rem;
            }

            #error span:last-child {
                font-size: 3rem;
                font-weight: 900;
            }

            #zoom {
                display: flex;
                align-items: center;
                gap: 4px;

                position: fixed;
                left: 1rem;
                bottom: 1rem;

                background-color: #1e1e2e;
                border: 2px solid #ffa6c1;
                border-radius: 4px;
                padding: 0.25rem;
            }

            #scale {
                font-size: 0.875rem;
                font-weight: 700;
            }

            #zoom button {
                display: flex;
                justify-content: center;
                align-items: center;

                background-color: transparent;
                color: #ffa6c1;

                outline: none;
                border: none;

                cursor: pointer;
            }

            #zoom button span {
                font-size: 1.4rem;

                transition: 200ms;
                transition-property: filter transform;
            }

            #zoom button span:hover {
                filter: brightness(75%);
            }

            #zoom button span:active {
                transform: scale(0.8);
            }

            @media only screen and (max-width: 1000px) {
                body {
                    grid-template-rows: 7.5rem auto;
                }

                header {
                    grid-template-columns: 1fr;
                    align-items: start;
                    padding-right: 0;
                }

                #right {
                    justify-content: start;
                }
            }
        </style>
    </head>
    <body>
        <header>
            <div id="left">
                <span id="file-name">{{ file }}</span>
                <span id="file-modified">Modified: {{ file_modified }}</span>
            </div>

            <div id="right">
                <div id="file-size">{{ file_size }}</div>

                <div id="seperator"></div>

                <div id="links">
                    <a id="copy" class="tooltip" data-tooltip="Copy Link" role="button" tabindex="0">
                        <span class="material-symbols-outlined">link</span>
                    </a>
                    <a id="raw" class="tooltip" data-tooltip="View Raw File" href="/uploads/{{ file }}/raw">
                        <span class="material-symbols-outlined">description</span>
                    </a>
                    <a id="download" class="tooltip" data-tooltip="Download" href="/uploads/{{ file }}/raw" download="{{ file }}">
                        <span class="material-symbols-outlined">download</span>
                    </a>
                </div>
            </div>
        </header>

        <main>
            <div id="error">
                <span>File could not be displayed</span>
                <span>(✖╭╮✖)</span>
            </div>

            <div id="zoom">
                <button id="minus-scale">
                    <span class="material-symbols-outlined">remove</span>
                </button>

                <span id="scale">100%</span>

                <button id="add-scale">
                    <span class="material-symbols-outlined">add</span>
                </button>
            </div>
        </main>

        <script type="module">
            const contentType = "{{ mime_type }}";
            const fileType = contentType.substring(0, contentType.indexOf("/"));

            const mainElement = document.querySelector("main");
            const errorElement = document.querySelector("#error");
            const copyButton = document.getElementById("copy");

            copyButton.addEventListener("click", () => {
                navigator.clipboard.writeText(window.location.href);
            });

            switch (fileType) {
                case "image":
                    const scaleText = document.getElementById("scale");
                    const addScaleButton = document.getElementById("add-scale");
                    const minusScaleButton =
                        document.getElementById("minus-scale");

                    const canvas = document.createElement("canvas");
                    canvas.width = mainElement.clientWidth;
                    canvas.height = mainElement.clientHeight;

                    const ctx = canvas.getContext("2d");

                    let dragging = false;
                    let scale = 100;

                    let startX = 0;
                    let startY = 0;
                    let offsetX = 0;
                    let offsetY = 0;

                    // Add image
                    const image = new Image();
                    image.addEventListener("load", () => {
                        centerImage();
                        draw();
                    });
                    image.src = "/uploads/{{ file }}/raw";

                    function draw() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.save();
                        ctx.translate(offsetX, offsetY);

                        ctx.drawImage(
                            image,
                            0,
                            0,
                            (image.width * scale) / 100,
                            (image.height * scale) / 100
                        );
                        scaleText.innerText = `${scale}%`;

                        ctx.restore();
                    }

                    function centerImage() {
                        offsetX =
                            (canvas.width - (image.width * scale) / 100) / 2;
                        offsetY =
                            (canvas.height - (image.height * scale) / 100) / 2;
                    }

                    window.addEventListener("resize", () => {
                        canvas.width = mainElement.clientWidth;
                        canvas.height = mainElement.clientHeight;
                        draw();
                    });

                    canvas.addEventListener("mousedown", (event) => {
                        dragging = true;
                        startX = event.offsetX - offsetX;
                        startY = event.offsetY - offsetY;

                        canvas.style.cursor = "grabbing";
                    });

                    canvas.addEventListener("mousemove", (event) => {
                        if (dragging) {
                            offsetX = event.offsetX - startX;
                            offsetY = event.offsetY - startY;
                            draw();
                        }
                    });

                    canvas.addEventListener("wheel", (event) => {
                        event.preventDefault();

                        const mouseX =
                            event.clientX - canvas.getBoundingClientRect().left;
                        const mouseY =
                            event.clientY - canvas.getBoundingClientRect().top;

                        // Get the current scale and new scale
                        const oldScale = scale;
                        scale += event.deltaY * -0.1; // Add the scroll to the scale
                        scale = Math.ceil(Math.min(Math.max(scale, 1), 10000)); // Set min and max to 1 and 10000

                        // Calculate the zoom factor
                        const zoomFactor = scale / oldScale;

                        // Adjust the offsetX and offsetY to ensure the zoom is centered at the mouse position
                        offsetX = mouseX - zoomFactor * (mouseX - offsetX);
                        offsetY = mouseY - zoomFactor * (mouseY - offsetY);

                        draw();
                    });

                    canvas.addEventListener("mouseup", () => {
                        dragging = false;
                        canvas.style.cursor = "grab";
                    });

                    canvas.addEventListener("mouseout", () => {
                        dragging = false;
                    });

                    addScaleButton.addEventListener("click", () => {
                        if (scale <= 10000) {
                            scale += 10;
                            centerImage();
                            draw();
                        }
                    });

                    minusScaleButton.addEventListener("click", () => {
                        if (scale >= 1) {
                            scale -= 10;
                            centerImage();
                            draw();
                        }
                    });

                    mainElement.append(canvas);
                    break;
                case "video":
                    const videoElement = document.createElement("video");
                    videoElement.src = "/uploads/{{ file }}/raw";
                    videoElement.controls = true;
                    videoElement.autoplay = true;

                    mainElement.append(videoElement);
                    break;
                case "text":
                    const preElement = document.createElement("pre");
                    const codeElement = document.createElement("code");
                    preElement.append(codeElement);

                    const response = await fetch("/uploads/{{ file }}/raw");
                    codeElement.textContent = await response.text();

                    mainElement.append(preElement);
                    hljs.highlightAll();
                    break;

                default:
                    errorElement.style.display = "flex";
                    break;
            }
        </script>
    </body>
</html>
